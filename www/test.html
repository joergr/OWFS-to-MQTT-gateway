<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--	<link href="css/home-assistant-display.css" rel="stylesheet">	-->
<!--	<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>	-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	<script type="text/javascript" src="js/mqttws31.js"></script>
	<title>Home Assistant Display</title>
	<style>
		h1 {
			font-size: 1.8em;
			font-weight: 200;
		}

		h2 {
			font-size: 1.6em;
			font-weight: 200;
		}
		.c0 {
			width: 120px;
			color: white;
			background-color: green;
			text-align: center;
		}
		.c1 {
			width: 120px;
			color: black;
			background-color: yellow;
			text-align: center;
		}
		.c2 {
			width: 120px;
			color: white;
			background-color: red;
			text-align: center;
		}
		body {
			max-width: 800px;
			min-width: 300px;
			margin: 0 auto;
			padding: 20px 10px;
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
			font-size: 14px;
			color: #c8c8c8;
			background-color: #272b30;
		}

		col-md-4 {
			position: relative;
			min-height: 1px;
			padding-left: 15px;
			padding-right: 15px;
			min-width: 200px;
		}
		button {
			width:350px;
		}
.panel-body {
  padding: 15px;
}
.panel-heading {
  padding: 10px 15px;
  border-bottom: 1px solid transparent;
  border-top-right-radius: 3px;
  border-top-left-radius: 3px;
}
	</style>
	<script type="text/javascript">
		var host = '192.168.1.39';
		var port = 8080;
		var username = ""; //null; //Default: 'home-assistant';
		var password = ""; //null; //Default: 'mypass';
		var useTLS = false;
		var cleansession = true;
		var reconnectTimeout = 2000;
		var switches = {
			"owfs1/burner": { name: "Brænder", id: "burner", on: "ON", off: "OFF" },
			"owfs1/pump": { name: "Pumpe", id: "pump", on: "ON", off: "OFF" },
			"owfs1/switch1": { name: "Sw1", id: "switch1", on: "ON", off: "OFF" },
			"owfs1/switch2": { name: "Sw2", id: "switch2", on: "ON", off: "OFF" },
			"owfs1/switch3": { name: "Sw3", id: "switch3", on: "ON", off: "OFF" },
			"owfs1/switch4": { name: "Sw4", id: "switch4", on: "ON", off: "OFF" },
			"owfs2/switch1": { name: "Sw5", id: "switch5", on: "ON", off: "OFF" },
			"owfs2/switch2": { name: "Sw6", id: "switch6", on: "ON", off: "OFF" }
			}
		var sensors = {
			"owfs1/fuel" : {name: "Olietank Lolland", id: "fuel4914", unit:"liter"},
			"owfs1/stuen" : {name: "Stuen Lolland", id: "stuenl4914", unit:"&deg;C"},
			"owfs1/depot": { name: "Depot Lolland", id: "depot4914", unit: "&deg;C" },
			"owfs1/orangeri": { name: "Orangeri Lolland", id: "orangeri4914", unit: "&deg;C" },
			"owfs2/temp": { name: "Temp", id: "temp3390", unit: "&deg;C" },
			"owfs2/vad": { name: "VAD", id: "vad3390", unit: "Volt" }
			}

		function makeSwitches() {
			var s = "";
			for (topic in switches) {
				with (switches[topic]) {
					s += "<tr>";
					s += ("<td class=\"col-md-4\">" + name + "</td>");
					s += ("<td colspan=\"2\" id='" + id + "'><button class=\"c1\">waiting</button></td>");
					s += "</tr>";
				}
			}
			return s;
		}

		function makeSensors() {
			var s = "";
			for (topic in sensors) {
				with (sensors[topic]) {
					s += ("<tr>");
					s += ("<td class=\"col-md-4\">" + name + "</td>");
					s += ("<td style=\"text-align:right\" id=\"" + id + "\">&nbsp;</td>");
					s += ("<td style=\"width:10px;\">&nbsp;" + unit + "</td>");
					s += ("</tr>");
				}
			}
			return s;
		}

		function checkSwitchTopic(_topic, _value) {
			try {
				with (switches[_topic]) {
					if (_value == '0') {
						$('#'+id).html("<button onclick='pub(\"" + _topic + "\",\"1\")' class='c0'>Off</button>");
					} else {
						$('#' + id).html("<button onclick='pub(\"" + _topic + "\",\"0\")' class='c2'>On</button>");
					}
				}
				$("#message").append(_topic + " " + _value + "<br/>")
				return true;
			} catch (err) {
				return false;
			}
		}

		function checkSensorTopic(_topic, _value) {
			try {
				if (sensors[_topic].unit == "&deg;C") {
					var f = parseFloat(_value);
					_value = f.toFixed(1);
				}
				with (sensors[_topic]) {
					$('#'+id).text(_value);
				}
				$("#message").append(_topic + " " + _value + "<br/>")
				return true;
			} catch (err) {
				return false;
			}
		}

		function pub(topic, value) {
			message = new Paho.MQTT.Message(value);
			message.destinationName = topic;
			client.send(message);
		}
		var client = new Paho.MQTT.Client(host, port, "ha-display" + parseInt(Math.random() * 100, 10));

		client.onConnectionLost = function (responseObject) {
			$('#status').append("Connection lost: " + responseObject.errorMessage + ". Reconnecting...<br/>");
		};

		client.onMessageArrived = function (message) {
			//$('#message').append(message.destinationName + ', ' + message.payloadString + '</br>');
			var topic = message.destinationName;
			checkSwitchTopic(topic, message.payloadString); 
			checkSensorTopic(topic, message.payloadString);
		};

		function subscribe(topic) {
			client.subscribe(topic, {
				qos: 0,
				onSuccess: function (message) {
					$('#status').append("Subscription '" + topic + "' ok" + '<br/>');
				}
			});
		}

		function onSucces() {
			var subs = {};
			for (x in sensors) {
				n = x.substr(0, x.indexOf("/") + 1)
				subs[n] = 0;
			}
			for (x in switches) {
				n = x.substr(0, x.indexOf("/") + 1)
				subs[n] = 0;
			}
			$('#status').html('Connected to ' + host + ':' + port + '<br/>');
			for (x in subs) subscribe(x);
		}

		var options = {
			timeout: 3,
			useSSL: useTLS,
			cleanSession: cleansession,
			onSuccess: function () {
				onSucces();
			},
			onFailure: function (message) {
				$('#status').html("Connection failed: " + message.errorMessage + "Retrying...<br/>");
				setTimeout(MQTTconnect, reconnectTimeout);
			}
		};

		if (username != null) {
			options.userName = username;
			options.password = password;
		}

		$(function () {
			s = makeSwitches();
			s += makeSensors();
			$("#tab").html(s);
			client.connect(options);
		})

	</script>
</head>
<body>
	<div style="width:90%;margin:auto;">
		<h1>Browser MQTT test</h1>
		<table style="width:100%">
			<tr>
				<th style="text-align:left">Name:</th>
				<th style="text-align:left">Status:</th>
				<th style="text-align:left">Latest MQTT message:</th>
			</tr>
			<tr>
				<td style="vertical-align:top">
					<table class="panel-body">
						<tbody id="tab" />
					</table>
				</td>
				<td style="vertical-align:top"><div id='status' style="vertical-align:top;max-height:200px; overflow:auto;"></div></td>
				<td style="vertical-align:top"><div id="message" style="vertical-align:top;max-height:200px; overflow:auto;"></div></td>
			</tr>
		</table>
	</div>
</body>
</html>
